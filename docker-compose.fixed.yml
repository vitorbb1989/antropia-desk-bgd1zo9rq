version: '3.8'

services:
  antropia-desk:
    image: antropia-desk:latest
    environment:
      - NODE_ENV=production
      - TZ=America/Sao_Paulo
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL:-URL_NOT_SET}
      - VITE_SUPABASE_PUBLISHABLE_KEY=${VITE_SUPABASE_PUBLISHABLE_KEY:-KEY_NOT_SET}
    networks:
      - minha_rede
    deploy:
      replicas: 1
      placement:
        max_replicas_per_node: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 5s
      labels:
        # Enable Traefik
        - "traefik.enable=true"
        - "traefik.docker.lbswarm=true"
        - "traefik.docker.network=minha_rede"

        # HTTP Router (redirect to HTTPS)
        - "traefik.http.routers.antropia-desk-http.rule=Host(`desk.antrop-ia.com`) || Host(`desk-status.antrop-ia.com`)"
        - "traefik.http.routers.antropia-desk-http.entrypoints=web"
        - "traefik.http.routers.antropia-desk-http.middlewares=redirect-to-https"

        # HTTPS Router
        - "traefik.http.routers.antropia-desk.rule=Host(`desk.antrop-ia.com`) || Host(`desk-status.antrop-ia.com`)"
        - "traefik.http.routers.antropia-desk.entrypoints=websecure"
        - "traefik.http.routers.antropia-desk.tls=true"
        - "traefik.http.routers.antropia-desk.tls.certresolver=letsencrypt"

        # Service
        - "traefik.http.services.antropia-desk.loadbalancer.server.port=80"

        # Middleware for HTTPS redirect
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  minha_rede:
    external: true