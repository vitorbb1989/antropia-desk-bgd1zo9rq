version: '3.8'

services:
  antropia-desk:
    image: antropia-desk:frontend
    environment:
      - NODE_ENV=production
      - TZ=America/Sao_Paulo
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL:-URL_NOT_SET}
      - VITE_SUPABASE_PUBLISHABLE_KEY=${VITE_SUPABASE_PUBLISHABLE_KEY:-KEY_NOT_SET}
    networks:
      - minha_rede
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 120s
      labels:
        # Traefik Labels (Docker Swarm - seguindo padr√£o Peppermint)
        - "traefik.enable=true"
        - "traefik.docker.lbswarm=true"
        - "traefik.docker.network=minha_rede"

        # HTTP Router (redirect para HTTPS)
        - "traefik.http.middlewares.redirect-desk-fe.redirectscheme.scheme=https"
        - "traefik.http.routers.desk-fe-http.entrypoints=web"
        - "traefik.http.routers.desk-fe-http.middlewares=redirect-desk-fe"
        - "traefik.http.routers.desk-fe-http.rule=Host(`desk.antrop-ia.com`) || Host(`desk-status.antrop-ia.com`)"

        # HTTPS Router - URLs oficiais
        - "traefik.http.routers.desk-fe.rule=Host(`desk.antrop-ia.com`) || Host(`desk-status.antrop-ia.com`)"
        - "traefik.http.routers.desk-fe.entrypoints=websecure"
        - "traefik.http.routers.desk-fe.tls=true"
        - "traefik.http.routers.desk-fe.tls.certresolver=letsencryptresolver"

        # Service - Porta 80 (Nginx production)
        - "traefik.http.services.desk-fe.loadbalancer.server.port=80"

networks:
  minha_rede:
    external: true